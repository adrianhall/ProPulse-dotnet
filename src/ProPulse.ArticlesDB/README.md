# ProPulse Articles DB

This project contains the database model for the Articles DB.  Each table is stored within its own SQL file.

## Schema

All tables are created within the default `[dbo]` schema of the ProPulse articles database.

## Common types

A User ID is at most 64 characters.

All date/time columns are stored with microsecond resolution and the UTC timezone, and indexed for efficient retrieval of rows between date/time points.

## Common properties

Every table except for join tables has the following columns:

* `[Id]` - a globally unique ID - represented as a Guid within the table.
* `[CreatedAt]` - the date/time that the row was created.
* `[CreatedBy]` - an optional string that indicated the user ID of the user that created the entity.
* `[UpdatedAt]` - the date/time that the row was last updated.
* `[UpdatedBy]` - an optional string that indicates the user ID of the user that last updated the entity.
* `[Version]` - the row version. An opaque value that changes whenever the row changes.  This is used as the ETag header when using RESTful conditional requests.

The `[UpdatedAt]` column will be updated automatically via trigger.

The `[CreatedBy]` and `[UpdatedBy]` fields are indexed to handle efficient retrieval of rows belonging to a user.

## Tables

The following tables will be available:

* `[Articles]` - the articles, with the following columns:
  * `[Title]`: required, varchar(255) - the title of the article.
  * `[Summary]`: optional, varchar(4096) - a summary of the article.
  * `[Content]`: required, text(64K) - the markdown content of the article.
  * `[State]`: required, enum(Draft, Published, Retired), indexed - the current state of the article.
  * `[PublishedAt]`: optional - the date/time that the article was published.
  * `[PublishedUntil]`: optional - the date/time that the article was retired.
* `[Attachments]` - attachments to an article
  * `[ArticleId]`: required, the ID of the article that this attachment refers to.
  * `[ContentType]`: required, varchar(255), indexed - the MIME content type of the attachment.
  * `[Path]`: required, varchar(255), indexed - the path of the attachment, as referenced in the article content.
  * `[Locator]`: required, varchar(255), indexed - the reference on the storage subsystem.
* `[Comments]` - comments attached to an article
  * `[ArticleId]`: required, the ID of the article that this attachment refers to.
  * `[Content]`: required, text(4K) - the content of the comment.
* `[Ratings]` - ratings for the article
  * `[ArticleId]`: required, the ID of the article that this attachment refers to.
  * `[Value]`: required, range 1-5 - the rating given to the article by an individual user
* `[Tags]` - the tags associated with an article
  * `[ArticleId]`: required, the ID of the article that this attachment refers to.
  * `[Name]`: required, varchar(255), indexed - the name of the tag
  * `[NormalizedName]`: required, varchar(255), indexed - the normalized name of the tag - generated by making the name upper-case.

## Triggers

Aside from the aforementioned trigger to update the `[UpdatedAt]` column, the `[Articles]` table has additional triggers:

* `[PublishedAt]` is updated to the current date/time if it is not set when the `[State]` changes from `Draft` to `Published`.
* `[PublishedAt]` is set to null when the `[State]` changes from `Published` or `Retired` to `Draft`.
* `[PublishedUntil]` is updated to the current date/time if it is not set when the `[State]` changes from `Published` to `Retired`.
* `[PublishedUnitl]` is set to null when the `[State]` changes from `Retired` to `Published` or `Draft`.

## Relationships

There are 1:many relationships between the following tables:

    Articles -> Attachments
    Articles -> Comments
    Articles -> Ratings

Cascade delete should work - i.e. deleting an article should also delete the attachments, comments, and ratings for the article.

There is a many:many relationship between `[Articles]` and `[Tags]` using a join table of `[ArticleTags]`.  Tags should not be deleted when an article is deleted (and vice versa).
